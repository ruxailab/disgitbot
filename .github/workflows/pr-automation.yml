name: PR Automation System

on:
  # Original triggers for this repo
  pull_request:
    types: [opened, synchronize, reopened]

  push:
    branches:
      - post_visualization_refactor

  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'process_pr'
        type: choice
        options:
          - process_pr
  
  # NEW: Make this workflow reusable for other repos
  workflow_call:
    inputs:
      repository:
        required: false
        type: string
        description: 'Repository name (owner/repo) - defaults to calling repo'
      pr_number:
        required: false
        type: number
        description: 'Pull request number - defaults to current PR'
      experience_level:
        required: false
        type: string
        default: 'intermediate'
        description: 'Developer experience level'
      action:
        required: false
        type: string
        default: 'process_pr'
        description: 'Action to perform'
    secrets:
      DEV_GH_TOKEN:
        required: true
      GOOGLE_API_KEY:
        required: true

jobs:
  # Process PR with AI automation
  process-pr:
    if: |
      github.event_name == 'pull_request' || 
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'workflow_call'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # If called from another repo, checkout this master repo
        repository: ${{ github.event_name == 'workflow_call' && 'ruxailab/disgitbot' || github.repository }}
        path: ${{ github.event_name == 'workflow_call' && 'pr-automation' || '.' }}
        token: ${{ secrets.DEV_GH_TOKEN || github.token }}
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Set up Google Credentials
      run: echo "${{ secrets.GOOGLE_CREDENTIALS_JSON }}" | base64 --decode > discord_bot/config/credentials.json
        
    - name: Install dependencies
      run: |
        cd ${{ github.event_name == 'workflow_call' && 'pr-automation/' || '' }}pr_review
        pip install -r requirements.txt
        
    - name: Run PR automation
      env:
        GITHUB_TOKEN: ${{ secrets.DEV_GH_TOKEN }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        GOOGLE_APPLICATION_CREDENTIALS: discord_bot/config/credentials.json
        PYTHONPATH: ${{ github.workspace }}
        # Enable Discord notifications for PR automation
        DISCORD_NOTIFICATIONS_ENABLED: true
      run: |
        cd ${{ github.event_name == 'workflow_call' && 'pr-automation/' || '' }}pr_review
        python main.py \
          ${{ inputs.repository || github.repository }} \
          ${{ inputs.pr_number || github.event.pull_request.number }} \
          ${{ inputs.experience_level || 'intermediate' }}
        
    - name: Upload processing logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pr-automation-logs-${{ inputs.pr_number || github.event.pull_request.number }}
        path: ${{ github.event_name == 'workflow_call' && 'pr-automation/' || '' }}pr_review/logs/
        retention-days: 7



  # Note: Label collection is now integrated into the Discord bot pipeline
  # Labels are automatically collected during the daily Discord bot data pipeline run

# Global environment variables for all jobs
env:
  PYTHONPATH: ${{ github.workspace }}/${{ github.event_name == 'workflow_call' && 'pr-automation/' || '' }}pr_review 
